<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="www.voca.ria.mission.mapper.MissionMapper">
	<resultMap id="rmMissionVO" extends="nsEntity.rmEntity"
			type="www.voca.ria.mission.model.MissionVO">
		<result property="isViewed" column="viewed" />
		<association property="tester" columnPrefix="tstr_"
				resultMap="www.voca.ria.party.mapper.PartyMapper.rmAccountVO" />
		<association property="tester" columnPrefix="mkr_"
				resultMap="www.voca.ria.party.mapper.PartyMapper.rmAccountVO" />
		<collection property="questionList" columnPrefix="qst_"
				resultMap="www.voca.ria.vocabulary.mapper.VocaMapper.rmQuestionVO">
		</collection>
	</resultMap>
	
	<!-- public List<MissionVO> listAllMission(@Param("accountId") String accountId,
			@Param("date") String dateString, @Param("page") PageDTO page); -->
	<select id="listAllMission" resultMap="rmMissionVO">
		select lm.*,
				quest.id quest_id,
					quest.question quest_question
		  from (
			select mission.*,
					tester.id tstr_id, tester.nick tstr_nick,
					maker.id mkr_id, maker.nick mkr_nick
			  from t_mission mission
			  left outer join t_account tester
			    on tester.id = mission.tester
			  left outer join t_account maker
			    on maker.id = mission.maker
			 where mission.time = #{date}
			   and tester.id = #{accountId}
			 limit ${page.onePageNum}
			offset ${page.offset}
			) lm
		  left outer join rel_mission_question rel
		    on rel.mission = lm.id
		  left outer join t_question quest
    	    on quest.id = rel.question
	</select>
	
	<!-- public int evaluate(@Param("questionIdList") List<String> questionIdList,
			@Param("chooseList") List<String> chooseList); -->
	<select id="evaluate" resultType="int">
		select sum(if(st.ans > 0, 1, 0)) score
		  from <foreach collection="questionIdList" item="questId" index="idx"
		  	open="(" separator="union all" close=")"
		  >
		    select choice.choice = #{chooseList[${idx}]} ans
		      from t_question quest
		      left outer join t_choice choice
		        on choice.question = quest.id
		     where quest.id = #{questId}
		       and choice.answer = 1
		  </foreach> st
	</select>
</mapper>
